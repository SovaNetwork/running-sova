services:
  satoshi-suite:
    build:
      context: ./satoshi-suite
      dockerfile: ../Dockerfile.satoshi-suite
    volumes:
      - ./logs:/app/logs
      - bitcoin-data:/root/.bitcoin
    networks:
      - corsa
    ports:
      - "5555:5555"
    command: >
      sh -c "just start-bitcoind > /app/logs/bitcoind.log &&
             just mine-blocks user-1 101 &&
             tail -f /app/logs/bitcoind.log"

  corsa-reth:
    build:
      context: ./corsa-reth
      dockerfile: Dockerfile
    environment:
      - BTC_NETWORK=regtest
      - BTC_RPC_URL=http://satoshi-suite
      - BTC_RPC_USER=user
      - BTC_RPC_PASSWORD=password
      - NETWORK_SIGNING_URL=http://corsa-enclave:5555
      - NETWORK_UTXO_URL=http://hyperstate-utxos:5557
      - BTX_TX_QUEUE_URL=http://bitcoin-tx-queue:5558
    ports:
      - "8545:8545"
    networks:
      - corsa
    depends_on:
      - satoshi-suite

  corsa-enclave:
    build:
      context: ./corsa-enclave
      dockerfile: Dockerfile
    environment:
      - RUST_LOG=info
    ports:
      - "5555:5555"
    networks:
      - corsa
    depends_on:
      - corsa-reth

  hyperstate-utxos:
    build:
      context: ./contracts
      dockerfile: Dockerfile
    environment:
      - RUST_LOG=info
    ports:
      - "5557:5557"
    networks:
      - corsa
    depends_on:
      - corsa-reth

  bitcoin-tx-queue:
    build:
      context: ./satoshi-suite
      dockerfile: Dockerfile
    environment:
      - RUST_LOG=info
    ports:
      - "5558:5558"
    networks:
      - corsa
    depends_on:
      - corsa-reth

  hyperstate-indexer:
    build:
      context: ./hyperstate-indexer
      dockerfile: Dockerfile
    environment:
      - RUST_LOG=info
      - WEBHOOK_URL=http://hyperstate-utxos:5557/hook
      - RPC_HOST=satoshi-suite
      - RPC_PORT=18443
      - RPC_USER=user
      - RPC_PASSWORD=password
    networks:
      - corsa
    depends_on:
      - hyperstate-utxos
      - satoshi-suite

  faucet:
    build:
      context: ./faucet
      dockerfile: Dockerfile
    environment:
      - RUST_LOG=info
    ports:
      - "5556:5556"
    networks:
      - corsa
    depends_on:
      - corsa-reth
    command: >
      corsa-testnet-faucet
      --rpc-url "http://corsa-reth:8545"
      --private-key "YOUR_PRIVATE_KEY_HERE"
      --tokens-per-request 10000000000000000000
      --port 5556
      --host 0.0.0.0
      --gas-price-gwei 1
      --gas-limit 21000

networks:
  corsa:
    driver: bridge

volumes:
  bitcoin-data:
  logs: